{{/* Attend .pages : les pages de la section blog */}}
{{ $pages := .pages }}

{{/* CATÉGORIES : map slug -> {name, slug, url, count} */}}
{{ $catMap := dict }}
{{ range $p := $pages }}
  {{ with $p.Params.categories }}
    {{ range . }}
      {{ $name := . }}
      {{ $slug := $name | urlize }}
      {{ $cur := index $catMap $slug }}
      {{ if $cur }}
        {{ $catMap = merge $catMap (dict $slug (merge $cur (dict "count" (add (index $cur "count") 1)))) }}
      {{ else }}
        {{ $catMap = merge $catMap (dict $slug (dict "name" $name "slug" $slug "url" (printf "/categories/%s/" $slug) "count" 1)) }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* catMap -> slice */}}
{{ $catList := slice }} {{ range $k, $v := $catMap }} {{ $catList = $catList | append $v }} {{ end }}

{{/* Détection automatique des 2 cibles */}}
{{ $articlesURL := "" }}
{{ $journalURL := "" }}
{{ range $cat := $catList }}
  {{ $ln := lower $cat.name }}
  {{ if and (eq $articlesURL "") (in $ln "article") }} {{ $articlesURL = $cat.url }} {{ end }}
  {{ if and (eq $journalURL "")  (in $ln "journal")  }} {{ $journalURL  = $cat.url }} {{ end }}
{{ end }}

{{/* Fallback : top catégories par count */}}
{{ if or (eq $articlesURL "") (eq $journalURL "") }}
  {{ $sorted := sort $catList "count" "desc" }}
  {{ if and (eq $articlesURL "") (ge (len $sorted) 1) }} {{ $articlesURL = (index $sorted 0).url }} {{ end }}
  {{ if and (eq $journalURL "")  (ge (len $sorted) 2) }} {{ $journalURL  = (index $sorted 1).url }} {{ end }}
{{ end }}

<div class="awsd-blog-filters">
  <!-- Ligne 1 : Articles (gauche) / Journal (droite) -->
  <div class="awsd-filter-top">
    <a class="awsd-pill" href="{{ $articlesURL | default "/categories/" }}">⬅ Articles</a>
    <a class="awsd-pill" href="{{ $journalURL  | default "/categories/" }}">Journal ➡</a>
  </div>

  <!-- TAGS : #tag en wrap -->
  {{ $tagMap := dict }}
  {{ range $p := $pages }}
    {{ with $p.Params.tags }}
      {{ range . }}
        {{ $name := . }}
        {{ $slug := $name | urlize }}
        {{ if not (index $tagMap $slug) }}
          {{ $tagMap = merge $tagMap (dict $slug (dict "name" $name "url" (printf "/tags/%s/" $slug))) }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}
  {{ $tagList := slice }} {{ range $k, $v := $tagMap }} {{ $tagList = $tagList | append $v }} {{ end }}

  <div class="awsd-filter-tags">
    {{ range sort $tagList "name" }}
      <a class="awsd-tag" href="{{ .url }}">#{{ .name }}</a>
    {{ end }}
  </div>
</div>
